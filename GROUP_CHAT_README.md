# 群聊功能 (Group Chat Feature)

## 🎉 新功能介绍

为 Chatbox 添加了完整的群聊功能，允许不同的 AI 模型/助手在同一会话中互相交流、辩论和协作。

## ✨ 核心特性

### 1. 基础群聊
- ✅ **多助手对话**: 支持添加多个 AI 助手参与对话
- ✅ **引用回复**: 助手可以引用并回复其他助手的消息
- ✅ **自动轮替**: 支持按顺序自动轮替助手回复
- ✅ **跳过回复**: 助手可以选择跳过当前轮次

### 2. 进阶玩法
- 🐺 **狼人杀**: 经典狼人杀游戏，助手们扮演不同角色进行推理和辩论
  - 支持 6-12 名参与者
  - 包含村民、狼人、预言家、女巫、猎人、守卫等角色
  - 完整的游戏流程（白天/黑夜阶段）
- 🎭 **辩论赛**: 助手们分成正反两方进行辩论
  - 支持正反各 4 名辩手（一辩至四辩）
  - 结构化的辩论流程
- 💡 **头脑风暴**: 围绕主题进行创意思维
  - 支持不同领域专家参与
  - 鼓励发散思维和跨界融合

### 3. 自定义玩法
- 🔄 **Flowchart 规则引擎**: 使用流程图自定义对话规则
  - 支持多种节点类型（开始、消息、条件、代理分配、动作、结束）
  - 支持条件判断和变量操作
  - 可视化编辑（待实现 UI）

## 📁 新增文件清单

### 类型定义
- `src/shared/types/session.ts` - 扩展类型定义
  - 添加 `Assistant` 类型
  - 添加 `GroupChatSettings` 类型
  - 扩展 `Message` 类型（支持引用回复）
  - 添加 `GameMode` 枚举
  - 添加 `Flowchart` 相关类型

### 状态管理
- `src/renderer/stores/assistantStore.ts` - 助手状态管理
  - 助手的增删改查
  - 预设助手模板
  - 数据持久化

- `src/renderer/stores/groupChatStore.ts` - 群聊会话管理
  - 群聊状态控制
  - 轮次管理
  - 自动回复逻辑

### 工具函数
- `src/renderer/utils/groupChatUtils.ts` - 群聊工具函数
  - 消息创建和格式化
  - 引用信息提取
  - 上下文构建
  - 助手选择逻辑

- `src/renderer/utils/gameModes.ts` - 游戏模式配置
  - 游戏模式定义
  - 预设角色配置
  - 角色提示词生成

- `src/renderer/utils/flowchartEngine.ts` - Flowchart 规则引擎
  - 流程图执行引擎
  - 节点类型处理
  - 条件判断逻辑
  - 动作执行系统

### UI 组件
- `src/renderer/components/GroupChatPanel.tsx` - 群聊面板
  - 助手选择界面
  - 游戏模式选择
  - 群聊控制按钮

- `src/renderer/components/ReplyButton.tsx` - 引用回复按钮
  - 消息引用功能
  - 悬停提示

- `src/renderer/components/ReplyPreview.tsx` - 引用预览组件
  - 显示被引用的助手信息
  - 取消引用功能

### 文档
- `docs/GROUP_CHAT_FEATURE.md` - 详细使用指南
  - 功能说明
  - 快速开始教程
  - 游戏模式详解
  - 最佳实践
  - 故障排除

## 🚀 使用示例

### 示例 1: 自由对话

```
用户：请介绍一下鲁迅和周树人在历史文学上的贡献。

助手A（理性分析师）：
鲁迅和周树人是历史上闻名的中国著名文学家。鲁迅是周树人的笔名，他在文学革命中发挥了重要作用，是新文化运动的主要倡导者之一...

助手B（创意设计师）：
> 回复 **助手A**

你的说法很准确。我想补充的是，鲁迅的作品不仅在文学上意义重大，在艺术性上也极具特色。他善于运用讽刺和批判手法...

助手A（理性分析师）：
> 回复 **助手B**

非常感谢你指出这个补充！确实，鲁迅的艺术风格非常独特，他的《狂人日记》开创了中国现代小说的先河...

助手C（哲学家）：
> 回复 **助手A**

从哲学角度来看，鲁迅的思想深受尼采影响，他对中国传统文化的批判具有很强的反思性...
```

### 示例 2: 狼人杀游戏

```
游戏开始！
角色分配：
- 玩家1：预言家
- 玩家2：狼人
- 玩家3：村民
- 玩家4：女巫
- 玩家5：狼人
- 玩家6：守卫

第一天夜晚...
狼人选择目标... 女巫选择是否使用解药...

第二天白天...
玩家1（预言家）：昨晚我查验了玩家3，他是好人。
玩家2（狼人）：我觉得玩家1在撒谎，我们投票把他投出去吧。
...
```

### 示例 3: 辩论赛

```
辩题：人工智能是否会取代人类工作？

正方一辩：我认为人工智能会在很多领域取代人类工作，因为...
反方一辩：对方辩友的观点有待商榷，AI更多是辅助而非取代...
正方二辩：让我补充一些数据和案例...
反方二辩：这些案例不能代表全部情况...
...
```

## 🔧 技术架构

### 数据流

```
用户输入 → 群聊控制器 → 选择助手 → 调用AI模型 → 生成消息 → 更新UI
              ↓
          Flowchart引擎（如果启用自定义规则）
```

### 关键模块

1. **AssistantStore**: 管理所有助手的配置和状态
2. **GroupChatStore**: 管理当前群聊会话的状态
3. **FlowchartEngine**: 执行自定义规则
4. **GameModes**: 提供预设的游戏模式和角色

### 扩展点

- 添加新的游戏模式：在 `gameModes.ts` 中定义
- 添加新的 Flowchart 节点类型：在 `flowchartEngine.ts` 中扩展
- 自定义助手行为：通过 `systemPrompt` 配置

## 📝 开发说明

### 依赖项

所有新增功能使用项目现有依赖：
- zustand (状态管理)
- zod (类型验证)
- mantine (UI 组件)
- react (前端框架)

### 集成到现有代码

要将群聊功能集成到现有代码，需要：

1. 在会话创建页面添加群聊模式选择
2. 在消息列表组件中添加引用回复功能
3. 在输入框组件中添加引用预览
4. 实现 AI 调用的轮替逻辑

### 已完成的框架

- ✅ 类型定义
- ✅ 状态管理
- ✅ 工具函数
- ✅ 游戏模式配置
- ✅ Flowchart 引擎
- ✅ UI 组件框架
- ⚠️ 集成到主应用（需要进一步开发）

## 🎯 下一步工作

### 短期目标
1. 将群聊面板集成到主应用界面
2. 实现消息列表中的引用显示
3. 实现输入框中的引用功能
4. 完善群聊会话的创建和删除流程

### 中期目标
1. 开发 Flowchart 可视化编辑器
2. 添加更多游戏模式（如角色扮演、推理游戏）
3. 实现群聊记录导出
4. 添加群聊分析和统计

### 长期目标
1. 支持语音输入/输出
2. 实时协作功能
3. 群聊模板和预设场景
4. 性能优化和大规模对话支持

## 🤝 贡献指南

欢迎贡献代码！以下是一些可以改进的方向：

- 添加新的游戏模式
- 优化 Flowchart 引擎性能
- 改进 UI/UX 设计
- 添加测试用例
- 完善文档

## 📄 许可证

本功能遵循 Chatbox 的 GPLv3 许可证。

## 🙏 致谢

感谢 Chatbox 社区的支持！

---

**开发者**: Coze Coding
**版本**: 1.0.0
**日期**: 2025-01-15
