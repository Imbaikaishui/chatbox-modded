# 群聊功能使用指南

## 功能概述

群聊功能允许不同的 AI 模型/助手在同一会话中互相交流、辩论和协作。这个功能包括：

### 基础功能
- **多助手对话**: 可以添加多个 AI 助手参与对话
- **引用回复**: 助手可以引用并回复其他助手的消息
- **自动轮替**: 可以设置助手按顺序自动回复
- **跳过回复**: 助手可以选择跳过当前轮次

### 进阶玩法
- **狼人杀**: 经典的狼人杀游戏，助手们扮演不同角色进行推理和辩论
- **辩论赛**: 助手们分成正反两方，围绕指定辩题进行辩论
- **头脑风暴**: 助手们围绕主题进行创意思维，激发灵感

### 自定义玩法
- **Flowchart 规则引擎**: 使用流程图自定义对话规则和逻辑

## 快速开始

### 1. 创建群聊会话

1. 打开 Chatbox 应用
2. 点击侧边栏的 "新建群聊" 按钮
3. 选择参与对话的助手（至少需要 2 个）

### 2. 添加助手

在群聊面板中，您可以：
- 从预设助手列表中选择
- 创建自定义助手
- 设置助手的系统提示词和模型

### 3. 选择游戏模式

支持以下模式：

#### 自由对话
- 无特定规则，助手们自由交流
- 适合一般性讨论和多角度分析

#### 狼人杀
- 需要至少 6 名参与者
- 每个助手被分配一个角色（村民、狼人、预言家、女巫等）
- 助手们通过推理和辩论找出狼人

#### 辩论赛
- 需要偶数名参与者
- 分成正反两方，各有一辩、二辩、三辩、四辩
- 围绕指定辩题进行辩论

#### 头脑风暴
- 围绕共同主题展开创意思维
- 每个助手代表不同领域的专家
- 鼓励发散思维和跨界融合

#### 自定义规则
- 使用 Flowchart 编辑器创建自定义规则
- 可以定义复杂的对话逻辑和条件判断

### 4. 开始群聊

点击 "开始群聊" 按钮启动对话：
- 用户可以发起第一个问题
- 助手们会根据设定依次回复
- 可以随时查看和引用历史消息

## 核心功能详解

### 引用回复

在群聊中，助手可以引用并回复其他助手的消息：

```
助手A：鲁迅和周树人在历史上都很重要...

助手B：> 回复 **助手A**

你的说法不对，鲁迅其实是周树人的本名...

助手A：> 回复 **助手B**

非常感谢你指出这个错误！确实，...
```

### 跳过回复

如果当前问题与某个助手无关，该助手可以选择跳过：

```
助手B：这是一个基本事实问题，无需进行更多回复。我选择跳过。
```

### 自定义助手

创建自定义助手时，可以设置：
- **名称**: 助手的显示名称
- **系统提示词**: 定义助手的性格和能力
- **模型**: 选择不同的 AI 模型（GPT-4, Claude, 等）
- **头像**: 自定义助手头像

### 游戏模式详解

#### 狼人杀

**角色配置**：
- 村民：普通角色，通过观察和推理找出狼人
- 狼人：每晚可以杀死一个村民
- 预言家：每晚可以查验一个人的身份
- 女巫：有一瓶解药和一瓶毒药
- 猎人：死亡时可以开枪带走一个人
- 守卫：每晚可以保护一个人

**游戏流程**：
1. **黑夜阶段**：狼人杀人，预言家查验，女巫使用药剂
2. **白天阶段**：所有角色讨论，投票处决可疑人员
3. **循环**：直到所有狼人被消灭或村民被杀光

#### 辩论赛

**角色配置**：
- 一辩：提出主要观点和立论框架
- 二辩：补充论据，驳斥对方论点
- 三辩：继续论证，深化观点
- 四辩：总结陈词，强调优势

**辩论流程**：
1. 正方一辩发言
2. 反方一辩发言
3. 依次进行二辩、三辩发言
4. 四辩总结陈词

#### 头脑风暴

**专家配置**：
可以添加不同领域的专家，例如：
- 技术专家
- 设计专家
- 市场专家
- 商业专家

**头脑风暴流程**：
1. 设定主题
2. 各专家提出创意想法
3. 互相启发和补充
4. 汇总和评估所有想法

## Flowchart 自定义规则

### 节点类型

1. **开始节点 (Start)**: 流程的起始点
2. **消息节点 (Message)**: 发送消息
3. **条件节点 (Condition)**: 条件判断
4. **代理分配节点 (Agent-Assign)**: 指定当前助手
5. **动作节点 (Action)**: 执行特定动作
6. **结束节点 (End)**: 流程结束

### 示例：循环聊天流程

```
[开始] → [发送消息] → [是否继续?] → [增加轮次] → [发送消息]
                                       ↓
                                    [结束]
```

### 条件表达式

支持简单的条件判断：
- `round < 10` - 轮次小于 10
- `score > 50` - 分数大于 50
- `hasMessage == true` - 是否有消息

### 动作类型

- `setVariable`: 设置变量
- `increment`: 增加变量值
- `sendMessage`: 发送消息

## 最佳实践

### 1. 合理设置助手数量

- **2-4 个助手**: 适合自由对话和简单讨论
- **4-8 个助手**: 适合辩论赛和头脑风暴
- **6-12 个助手**: 适合狼人杀等复杂游戏

### 2. 优化系统提示词

为每个助手设计独特的系统提示词：
```
你是理性分析师，你的回答基于事实和数据，
逻辑清晰，善于从多个角度分析问题。
```

### 3. 使用引用回复

引用其他助手的观点可以提高对话连贯性：
```
> 回复 **助手A**

我同意你的观点，但我想补充一点...
```

### 4. 控制轮次长度

设置合理的最大轮次，避免无限循环：
- 自由对话：5-10 轮
- 辩论赛：4-8 轮
- 狼人杀：根据游戏进度

### 5. 定期总结

在长对话中，可以添加一个总结助手：
```
你是总结助手，你的任务是总结前面的对话内容，
提取关键观点和结论。
```

## 技术实现

### 核心文件

- `src/shared/types/session.ts`: 类型定义
- `src/renderer/stores/assistantStore.ts`: 助手状态管理
- `src/renderer/stores/groupChatStore.ts`: 群聊状态管理
- `src/renderer/utils/groupChatUtils.ts`: 群聊工具函数
- `src/renderer/utils/gameModes.ts`: 游戏模式配置
- `src/renderer/utils/flowchartEngine.ts`: Flowchart 引擎
- `src/renderer/components/GroupChatPanel.tsx`: 群聊面板组件

### 数据结构

**Assistant**
```typescript
{
  id: string
  name: string
  avatar?: string
  systemPrompt?: string
  provider: string
  modelId: string
  isActive: boolean
  isUser: boolean
}
```

**GroupChatSettings**
```typescript
{
  assistants: Assistant[]
  gameMode: GameMode
  flowchart?: Flowchart
  autoReply: boolean
  replyOrder?: string[]
  maxRounds: number
}
```

**Message (扩展)**
```typescript
{
  // 原有字段...
  assistantId?: string
  replyToMessageId?: string
  replyToAssistantId?: string
  round?: number
  skip?: boolean
}
```

## 故障排除

### 问题 1: 助手不回复

**原因**：
- 助手未激活
- 模型配置错误
- API 配额不足

**解决方案**：
- 检查助手的 `isActive` 状态
- 验证模型配置和 API Key
- 查看控制台错误日志

### 问题 2: 群聊卡住

**原因**：
- 循环条件未满足
- Flowchart 配置错误
- 某个助手返回错误

**解决方案**：
- 检查轮次限制
- 验证 Flowchart 逻辑
- 重启群聊

### 问题 3: 引用回复不工作

**原因**：
- 消息 ID 未正确传递
- 引用格式错误

**解决方案**：
- 确保使用正确的引用格式
- 检查消息 ID 是否有效

## 未来计划

- [ ] 添加更多游戏模式（如角色扮演、推理游戏）
- [ ] 支持语音输入/输出
- [ ] 实时协作功能
- [ ] 群聊模板和预设场景
- [ ] 导出群聊记录
- [ ] 群聊分析和统计

## 贡献

欢迎提交 Issue 和 Pull Request 来改进群聊功能！

## 许可证

本功能遵循 Chatbox 的 GPLv3 许可证。
